<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>H·ªì s∆° ng∆∞·ªùi d√πng - Github Pharmacy</title>
    <link rel="stylesheet" href="home.css" />
</head>

<body>
    <!-- HEADER -->
    <header class="header">
        <div class="header__inner container">
            <div class="brand">
                <a href="home.html" style="text-decoration: none; display: flex; align-items: center; gap: 14px;">
                    <div class="brand__logo" aria-label="Github logo">
                        <span class="logo-dot"></span>
                        <span class="logo-dot"></span>
                        <span class="logo-dot"></span>
                    </div>
                    <div class="brand__text">
                        <div class="brand__name">Github Pharmacy</div>
                    </div>
                </a>
            </div>

            <div class="search">
                <input id="globalSearch" type="search" placeholder="T√¨m t√™n thu·ªëc, m√£ thu·ªëc..." />
                <button id="btnSearch" class="btn btn--icon" title="T√¨m ki·∫øm" aria-label="T√¨m ki·∫øm">
                    üîç
                </button>
            </div>

            <div class="header__actions">
                <a href="profile.html" id="btnLogout" class="btn btn--ghost" style="text-decoration: none;">
                    üë§ <span id="headerUsername">T√†i kho·∫£n</span>
                </a>
                <button id="btnCart" class="btn btn--primary" onclick="window.location.href='cart.html'">
                    üõí Gi·ªè h√†ng <span id="cartBadge" class="badge">0</span>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN PROFILE LAYOUT -->
    <main class="container main">
        <div class="profile-layout">

            <!-- SIDEBAR -->
            <aside class="profile-sidebar">
                <div class="profile-user">
                    <div class="profile-user__avatar">üë§</div>
                    <div class="profile-user__info">
                        <div id="sbName" class="profile-user__name">User Name</div>
                        <div id="sbRole" class="profile-user__role">Member</div>
                    </div>
                </div>

                <nav class="profile-nav">
                    <button class="profile-nav__item active" onclick="showTab('overview')">
                        üîπ T·ªïng quan
                    </button>
                    <button class="profile-nav__item" onclick="showTab('history')">
                        üìã L·ªãch s·ª≠ mua h√†ng
                    </button>
                    <button class="profile-nav__item" onclick="showTab('info')">
                        üë§ Th√¥ng tin c√° nh√¢n
                    </button>
                    <div id="adminLinkContainer"></div>
                </nav>

                <button class="profile-logout"
                    onclick="localStorage.removeItem('cache_auth'); window.location.href='logout'">
                    üö™ ƒêƒÉng xu·∫•t
                </button>
            </aside>

            <!-- CONTENT AREA -->
            <div class="profile-content">

                <!-- Tab: Overview -->
                <div id="tab-overview" class="profile-tab active">
                    <h2 class="profile-heading">T·ªïng quan</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card__icon">üõí</div>
                            <div class="stat-card__info">
                                <div id="summaryCount" class="stat-card__value">0</div>
                                <div class="stat-card__label">ƒê∆°n h√†ng ƒë√£ mua</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card__icon">üí∞</div>
                            <div class="stat-card__info">
                                <div id="summaryTotal" class="stat-card__value">0ƒë</div>
                                <div class="stat-card__label">T·ªïng ti·ªÅn t√≠ch l≈©y</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 32px;">
                        <h3 style="margin-bottom: 16px;">ƒê∆°n h√†ng g·∫ßn ƒë√¢y</h3>
                        <div class="empty-state">
                            Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o g·∫ßn ƒë√¢y. <a href="home.html">Mua s·∫Øm ngay</a>
                        </div>
                    </div>
                </div>

                <!-- Tab: Purchase History -->
                <div id="tab-history" class="profile-tab">
                    <h2 class="profile-heading">L·ªãch s·ª≠ mua h√†ng</h2>
                    <div class="empty-state">
                        B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.
                    </div>
                </div>

                <!-- Tab: Personal Info -->
                <div id="tab-info" class="profile-tab">
                    <h2 class="profile-heading">Th√¥ng tin c√° nh√¢n</h2>
                    <div class="info-card">
                        <div class="field">
                            <span>H·ªç v√† t√™n</span>
                            <input type="text" id="infoName" class="info-input" readonly>
                        </div>
                        <div class="field">
                            <span>S·ªë ƒëi·ªán tho·∫°i</span>
                            <input type="text" id="infoPhone" class="info-input" readonly>
                        </div>
                        <div class="field">
                            <span>ƒê·ªãa ch·ªâ</span>
                            <input type="text" id="infoAddress" class="info-input" readonly>
                        </div>
                        <div class="field">
                            <span>T√™n ƒëƒÉng nh·∫≠p</span>
                            <input type="text" id="infoUsername" class="info-input" readonly>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container footer__inner">
            Connect with us : 03xxxxxxx
        </div>
    </footer>

    <!-- SUCCESS/QR MODAL -->
    <div class="success-modal" id="successModal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="success-content"
            style="background: white; border-radius: 16px; padding: 30px; text-align: center; max-width: 400px; width: 90%; position: relative;">
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        let pollingInterval = null;

        // 1. Fetch real auth state from server
        async function loadProfile() {
            try {
                const res = await fetch('api/auth-status');
                const data = await res.json();

                if (!data.isLoggedIn) {
                    window.location.href = 'login.html';
                    return;
                }

                const currentUser = data;

                // 2. Bind Header
                document.getElementById('headerUsername').textContent = currentUser.fullName;
                document.getElementById('cartBadge').textContent = JSON.parse(localStorage.getItem("cart") || "[]").length;

                // 3. Bind Sidebar
                document.getElementById('sbName').textContent = currentUser.fullName;
                document.getElementById('sbRole').textContent = currentUser.role === 'ADMIN' ? 'Qu·∫£n tr·ªã vi√™n' : 'Th√†nh vi√™n';

                // Admin Link
                if (currentUser.role === 'ADMIN') {
                    document.getElementById('adminLinkContainer').innerHTML = `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                        <a href="/admin/users" class="profile-nav__item" style="text-decoration:none;">
                            ‚öôÔ∏è Qu·∫£n l√Ω ng∆∞·ªùi d√πng
                        </a>
                        <a href="/admin/sales" class="profile-nav__item" style="text-decoration:none;">
                            üí∞ Doanh thu & Ti·ªÅn l·ªùi
                        </a>
                    </div>
                `;
                }

                // 4. Bind Info Tab
                document.getElementById('infoName').value = currentUser.fullName || '';
                document.getElementById('infoPhone').value = currentUser.phone || "Ch∆∞a c·∫≠p nh·∫≠t";
                document.getElementById('infoAddress').value = currentUser.address || "Ch∆∞a c·∫≠p nh·∫≠t";
                document.getElementById('infoUsername').value = currentUser.username || 'user';

                // 5. Fetch Orders
                fetchOrders();
            } catch (e) {
                console.error("Failed to load profile", e);
            }
        }

        async function fetchOrders() {
            try {
                console.log("Fetching orders...");
                const res = await fetch('api/orders');
                const orders = await res.json();
                console.log("Orders received:", orders);

                const historyTab = document.getElementById('tab-history');
                const overviewList = document.querySelector('#tab-overview .empty-state');
                const summaryTotal = document.getElementById('summaryTotal');
                const summaryCount = document.getElementById('summaryCount');

                const paidOrders = (orders || []).filter(o => o.status === 'PAID');
                summaryCount.textContent = paidOrders.length;
                let totalSpent = paidOrders.reduce((sum, o) => sum + o.total, 0);

                if (!orders || orders.length === 0) {
                    historyTab.innerHTML = `<h2 class="profile-heading">L·ªãch s·ª≠ mua h√†ng</h2><div class="empty-state">B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</div>`;
                    summaryTotal.textContent = "0ƒë";
                    return;
                }

                const renderOrder = (o) => {
                    const dateStr = `${o.day}/${o.month}/${o.year}`;

                    // Logic m√†u s·∫Øc tr·∫°ng th√°i
                    let statusLabel = '‚è≥ Ch·ªù x√°c nh·∫≠n';
                    let statusColor = '#f59e0b';
                    let statusBg = '#fffbeb';

                    if (o.status === 'PAID') {
                        statusLabel = '‚úÖ ƒê√£ ho√†n t·∫•t';
                        statusColor = '#10b981';
                        statusBg = '#f0fdf4';
                    } else if (o.status === 'CANCELLED') {
                        statusLabel = '‚ùå ƒê√£ b·ªã h·ªßy';
                        statusColor = '#ef4444';
                        statusBg = '#fef2f2';
                    }

                    return `
                        <div class="order-card" style="border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px; background: #fff; box-shadow: var(--shadow-sm); transition: transform 0.2s;">
                            <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px;">
                                <div>
                                    <span style="font-weight:700; color: var(--primary); display:block;">ƒê∆°n #INV-${o.id}</span>
                                    <span style="font-size: 11px; color: var(--text-muted);">${dateStr}</span>
                                </div>
                                <div style="text-align: right;">
                                    <span style="display: block; font-weight:800; color: var(--gold); font-size: 16px;">${o.total.toLocaleString('vi-VN')}ƒë</span>
                                    <span style="display: inline-block; font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 20px; color: ${statusColor}; background: ${statusBg}; border: 1px solid ${statusColor}33; margin-top: 4px;">
                                        ${statusLabel}
                                    </span>
                                </div>
                            </div>
                            <div style="font-size: 13px; margin-bottom: 8px;">
                                ${o.items.map(item => `
                                    <div style="display:flex; justify-content:space-between; margin-bottom: 4px;">
                                        <span style="color: #475569;">${item.name} <span style="color: #94a3b8;">x${item.qty}</span></span>
                                        <span style="font-weight: 600;">${(item.price * item.qty).toLocaleString('vi-VN')}ƒë</span>
                                    </div>
                                `).join('')}
                            </div>
                            ${o.status === 'PENDING' ? `
                                <div style="margin-top: 10px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                    <div style="font-size: 11px; color: #64748b; font-style: italic; margin-bottom: 10px;">
                                        üí° ƒê∆°n h√†ng ƒëang ch·ªù thanh to√°n qua ng√¢n h√†ng.
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="showQR(${o.id}, ${o.total})" style="flex: 1; padding: 8px; background: #6366f1; color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 700; cursor: pointer;">üí≥ Thanh to√°n / Xem m√£ QR</button>
                                        <button onclick="cancelOrder(${o.id})" style="padding: 8px; background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; border-radius: 6px; font-size: 11px; font-weight: 700; cursor: pointer;">‚úï H·ªßy ƒë∆°n</button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                };

                historyTab.innerHTML = `<h2 class="profile-heading">L·ªãch s·ª≠ mua h√†ng</h2>` + orders.map(renderOrder).join('');
                if (overviewList) {
                    overviewList.parentElement.innerHTML = `<h3 style="margin-bottom: 16px;">ƒê∆°n h√†ng g·∫ßn ƒë√¢y</h3>` + orders.slice(0, 3).map(renderOrder).join('');
                } else {
                    // Update content if empty state was replaced
                    const recentHeader = document.querySelector('#tab-overview h3');
                    if (recentHeader && recentHeader.nextElementSibling) {
                        recentHeader.nextElementSibling.outerHTML = orders.slice(0, 3).map(renderOrder).join('');
                    }
                }
                summaryTotal.textContent = totalSpent.toLocaleString('vi-VN') + "ƒë";
            } catch (e) {
                console.error("Order fetch error", e);
            }
        }

        // ==== MODAL QR ====
        function showQR(id, amount) {
            const modal = document.getElementById('successModal');
            const body = document.getElementById('modalBody');
            const qrUrl = `https://qr.sepay.vn/img?bank=MB&acc=3399377355&template=compact&amount=${amount}&des=DH${id}`;

            body.innerHTML = `
                <div style="padding: 5px;">
                    <div style="text-align: right; margin-bottom: -10px;">
                        <button onclick="closeModal()" style="background:none; border:none; font-size: 24px; cursor:pointer; color:#94a3b8;">&times;</button>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: 800; font-size: 18px; color: #1e293b;">Thanh to√°n ƒë∆°n #${id}</div>
                        <div style="font-size: 13px; color: #64748b;">M·ªü app ng√¢n h√†ng ƒë·ªÉ qu√©t m√£ VietQR</div>
                    </div>
                    
                    <div style="background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                        <img src="${qrUrl}" style="width: 100%; max-width: 220px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                    </div>

                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px; margin-bottom: 15px; text-align: left;">
                         <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="font-size: 12px; color: #64748b;">T·ªïng ti·ªÅn:</span>
                            <span style="font-weight: 800; color: #dc2626;">${amount.toLocaleString('vi-VN')}ƒë</span>
                         </div>
                         <div style="display:flex; justify-content:space-between;">
                            <span style="font-size: 12px; color: #64748b;">N·ªôi dung:</span>
                            <span style="font-weight: 800; color: #1e3a8a;">DH${id}</span>
                         </div>
                    </div>

                    <div id="pollingStatus" style="font-size: 12px; color: #6366f1; font-weight: 600; display:flex; align-items:center; justify-content:center; gap: 8px;">
                        <div style="width: 14px; height: 14px; border: 2px solid #e2e8f0; border-top-color: #6366f1; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        ƒêang ch·ªù h·ªá th·ªëng x√°c th·ª±c...
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
            startPolling(id);
        }

        function closeModal() {
            document.getElementById('successModal').style.display = 'none';
            if (pollingInterval) clearInterval(pollingInterval);
        }

        function startPolling(id) {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(async () => {
                try {
                    const res = await fetch(`api/orders/status?invoiceId=${id}`);
                    if (res.ok) {
                        const data = await res.json();
                        if (data.status === 'PAID') {
                            clearInterval(pollingInterval);
                            alert("‚úÖ Thanh to√°n ho√†n t·∫•t!");
                            location.reload();
                        }
                    }
                } catch (e) { }
            }, 5000);
        }

        async function cancelOrder(id) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë∆°n h√†ng #${id}?`)) return;
            try {
                const res = await fetch('api/orders', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId: id, status: 'CANCELLED' })
                });
                if (res.ok) {
                    alert("üóëÔ∏è ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c h·ªßy.");
                    location.reload();
                } else {
                    const data = await res.json();
                    alert("L·ªói: " + (data.message || "Kh√¥ng th·ªÉ h·ªßy ƒë∆°n."));
                }
            } catch (e) {
                alert("L·ªói k·∫øt n·ªëi server.");
            }
        }

        loadProfile();

        // Tab Switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.profile-tab').forEach(el => el.classList.remove('active'));
            // Show selected
            document.getElementById('tab-' + tabName).classList.add('active');

            // Update sidebar active state
            document.querySelectorAll('.profile-nav__item').forEach(el => el.classList.remove('active'));
            // currentTarget check
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
        }
    </script>
    <style>
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</body>

</html>